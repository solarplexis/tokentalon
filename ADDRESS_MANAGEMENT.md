# Address Management System

This directory contains the unified deployment and address management system for TokenTalon contracts. This system eliminates manual copy-paste errors by automatically synchronizing contract addresses across the frontend, backend, and deployment records.

## ğŸ¯ Problem Solved

**Before**: Deploying contracts required manually copying addresses to multiple config files, leading to hours of debugging due to address mismatches.

**After**: One command deploys contracts and automatically syncs addresses everywhere. Zero manual copy-paste needed.

## ğŸ“ File Structure

```
common/
â”œâ”€â”€ deployments/              # Single source of truth for all deployments
â”‚   â”œâ”€â”€ hardhat.json         # Local development deployment
â”‚   â”œâ”€â”€ sepolia.json         # Sepolia testnet deployment
â”‚   â””â”€â”€ polygon.json         # Polygon mainnet deployment
â”‚
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ deploy-and-sync.ts   # Main deployment script (auto-syncs addresses)
â”‚   â”œâ”€â”€ validate-deployment.ts  # Validates sync across all systems
â”‚   â””â”€â”€ show-addresses.ts    # Quick reference for deployment info
â”‚
client/lib/contracts/
â””â”€â”€ addresses.ts             # AUTO-GENERATED - Frontend contract addresses

server/src/config/
â””â”€â”€ contracts.ts             # AUTO-GENERATED - Backend contract addresses
```

## ğŸš€ Usage

### Deploy Contracts

Deploy to any network and automatically sync addresses:

```bash
cd common

# Deploy to Sepolia testnet
npm run deploy:sepolia

# Deploy to Polygon mainnet
npm run deploy:polygon

# Deploy to local hardhat (ephemeral)
npx hardhat run scripts/deploy-and-sync.ts --network hardhat
```

**What happens:**
1. âœ… Deploys GameToken, PrizeNFT, and ClawMachine contracts
2. âœ… Saves deployment info to `deployments/{network}.json`
3. âœ… Auto-generates `client/lib/contracts/addresses.ts`
4. âœ… Auto-generates `server/src/config/contracts.ts`
5. âœ… Prints verification commands and next steps

### View Deployment Info

```bash
# Show specific network
npm run addresses:sepolia

# Show all deployments
npm run addresses:all
```

**Output includes:**
- Contract addresses with block numbers and tx hashes
- Explorer links for each contract
- Oracle configuration
- Copy-paste ready environment variables
- Verification commands

### Validate Sync

Check that all addresses are synchronized across systems:

```bash
npm run validate:sepolia
```

**Checks:**
- âœ… All addresses are valid Ethereum addresses
- âœ… Contracts are actually deployed on-chain
- âœ… Frontend config matches deployment.json
- âœ… Backend config matches deployment.json
- âœ… Contract ownership is correct

## ğŸ“‹ Deployment Record Format

Each `deployments/{network}.json` file contains:

```json
{
  "network": "sepolia",
  "chainId": 11155111,
  "deployedAt": "2025-11-27T10:30:00.000Z",
  "deployer": "0x1234...abcd",
  "contracts": {
    "GameToken": {
      "address": "0x5678...ef01",
      "blockNumber": 4567890,
      "transactionHash": "0xabc...123",
      "constructorArgs": [...],
      "verified": false,
      "version": "1.0.0"
    },
    // ... PrizeNFT, ClawMachine
  },
  "oracle": {
    "address": "0xabcd...ef01",
    "description": "Backend signing wallet"
  },
  "metadata": {
    "rpcUrl": "https://...",
    "explorerUrl": "https://sepolia.etherscan.io",
    "deploymentNotes": "..."
  }
}
```

## ğŸ”„ Workflow Example

Complete deployment workflow for Sepolia testnet:

```bash
# 1. Deploy contracts and auto-sync addresses
npm run deploy:sepolia

# 2. Verify deployment is synced correctly
npm run validate:sepolia

# 3. View deployment info
npm run addresses:sepolia

# 4. (Optional) Verify contracts on Etherscan
# Copy verification commands from deployment output
```

## ğŸ“ Auto-Generated Files

### Client (`client/lib/contracts/addresses.ts`)

```typescript
// Auto-generated by deploy-and-sync.ts - DO NOT EDIT MANUALLY
export const CONTRACTS = {
  sepolia: {
    gameToken: "0x5678...ef01" as `0x${string}`,
    prizeNFT: "0x1234...5678" as `0x${string}`,
    clawMachine: "0x9abc...def2" as `0x${string}`,
  }
} as const;

export const ORACLE_ADDRESS = "0xabcd...ef01" as `0x${string}`;
export const NETWORK_CONFIG = { ... } as const;
```

### Server (`server/src/config/contracts.ts`)

```typescript
// Auto-generated by deploy-and-sync.ts - DO NOT EDIT MANUALLY
export const CONTRACTS = {
  sepolia: {
    gameToken: "0x5678...ef01",
    prizeNFT: "0x1234...5678",
    clawMachine: "0x9abc...def2",
  }
};

export const ORACLE_ADDRESS = "0xabcd...ef01";
export const NETWORK_CONFIG = { ... };
```

## âš ï¸ Important Notes

1. **Never Edit Auto-Generated Files**: The `addresses.ts` and `contracts.ts` files are auto-generated. Any manual edits will be overwritten on the next deployment.

2. **Commit Deployment Files**: The `deployments/` directory is committed to git to share deployment info across the team.

3. **Environment Variables**: The deployment scripts read from `.env`:
   - `SEPOLIA_RPC_URL` - RPC endpoint for Sepolia
   - `PRIVATE_KEY` - Deployer private key
   - `ORACLE_ADDRESS` - (Optional) Backend oracle address
   - `DEPLOYMENT_NOTES` - (Optional) Notes for this deployment

4. **Network Names**: The system maps network names:
   - `hardhat` â†’ `localhost` (in generated configs)
   - `sepolia` â†’ `sepolia`
   - `polygon` â†’ `polygon`
   - `amoy` â†’ `polygonAmoy`

## ğŸ‰ Benefits

- â±ï¸ **Time Savings**: Deploy and sync in ~2 minutes vs 30 minutes manual
- ğŸ”’ **Reliability**: Automated sync eliminates human error
- âœ… **Validation**: Catch mismatches before they cause issues
- ğŸ“š **History**: Complete audit trail of all deployments
- ğŸ”„ **Reproducible**: Anyone can redeploy with exact same config
- ğŸ‘¥ **Team-Friendly**: Shared deployment info across team
- ğŸ› **Debugging**: Easy to verify what's deployed where

## ğŸ”§ Troubleshooting

### Addresses Don't Match

```bash
# Re-run deployment to regenerate config files
npm run deploy:sepolia

# Verify sync
npm run validate:sepolia
```

### Can't Find Deployment

```bash
# List all available deployments
npm run addresses:all
```

### Validation Fails for Hardhat Network

This is expected - hardhat network is ephemeral and doesn't persist. The validation will fail for on-chain checks, but frontend/backend sync checks should still pass.

## ğŸ“– Related Documentation

- [ADMIN_FUNCTIONS_SPEC.md](../ADMIN_FUNCTIONS_SPEC.md) - Complete admin functions specification
- [README.md](../README.md) - Project overview

---

**Last Updated**: 2025-11-27
**Status**: âœ… Implemented and Tested
